
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!-- ‡§¨‡§¶‡§≤‡§æ ‡§π‡•Å‡§Ü Viewport: ‡§ú‡§º‡•Ç‡§Æ ‡§ï‡•ã ‡§¨‡§Ç‡§¶ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, minimum-scale=1.0">
<title>CoinMine App - Telegram Mini App</title>
<!-- =================================================================== -->
<!-- BOTH SDKs ARE NOW INCLUDED -->
<script src='//libtl.com/sdk.js' data-zone='9969043' data-sdk='show_9969043'></script>
<script src="https://sad.adsgram.ai/js/sad.min.js"></script>
<!-- Giga Pub SDK Included (New) -->
<script src="https://ad.gigapub.tech/script?id=4931"></script>
<!-- =================================================================== -->
<style>
/* === Professional Gradient & Glow Theme === */
:root {
    --primary-glow: #00E5FF; /* Bright Cyan */
    --secondary-glow: #FFD700; /* Gold */
    --bg-dark: #0D1117; /* Very Dark Blue-Gray */
    --bg-light: #161B22; /* Lighter version for cards */
    --text-light: #E6EDF3;
    --text-dark: #8B949E;
    --border-color: #30363D;
    --gradient-start: #1c0f2b; /* Deep Purple */
    --gradient-end: #0a0c24;   /* Deep Blue */
}

*{margin:0;padding:0;box-sizing:border-box;font-family:'Poppins', sans-serif}
html, body {
    height: 100%;
    overflow: hidden; /* Prevent scrolling on the body */
}
body{
  background-color: var(--bg-dark);
  background-image: radial-gradient(ellipse 80% 100% at 50% 120%, var(--gradient-start), var(--gradient-end));
  color: var(--text-light);
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:flex-start;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}
header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  width:100%;
  padding:15px 20px;
  background: rgba(13, 17, 23, 0.7);
  backdrop-filter: blur(10px);
  box-shadow:0 2px 8px rgba(0,0,0,0.6);
  border-bottom: 1px solid var(--border-color);
  position:fixed;
  top:0;
  z-index:100;
  flex-shrink: 0;
}
header .profile{cursor:pointer;display:flex;align-items:center;gap:10px}
header .profile img{width:45px;height:45px;border-radius:50%;border:2px solid var(--primary-glow)}
header .profile span{font-weight:600;color: var(--text-light)}
header .msg-icon{cursor:pointer;font-size:26px;color:var(--primary-glow)}

main{
  flex:1;
  display:flex;
  flex-direction:column;
  align-items:center;
  width:100%;
  padding-top:76px; /* Header height */
  padding-bottom: 65px; /* Navbar height */
  overflow-y: auto; /* Allow scrolling within main content */
}
.section{display:none;width:100%;padding:20px;animation:fadeIn 0.3s ease;}
#home{display:block;}
#home h2{font-size:24px;margin-bottom:5px;color:var(--text-light);text-align: center;}
#totalCoins{font-size:48px;color:var(--secondary-glow);font-weight:700;margin-bottom:40px;text-shadow: 0 0 15px rgba(255, 215, 0, 0.6);text-align: center;}
.circle-container{position:relative;display:flex;align-items:center;justify-content:center;width: 100%;margin-top: 20px;}

.circle {
    width:280px;
    height:280px;
    border-radius:50%;
    background: radial-gradient(ellipse at center, rgba(13, 17, 23, 0.1), transparent 70%),
                radial-gradient(ellipse at center, rgba(0, 229, 255, 0.1), var(--bg-dark) 75%);
    display:flex;
    align-items:center;
    justify-content:center;
    position: relative;
    cursor:pointer;
    overflow:hidden;
    border: 2px solid var(--primary-glow);
    box-shadow: inset 0 0 40px rgba(0, 229, 255, 0.2), 0 0 30px rgba(0, 229, 255, 0.4), 0 0 60px rgba(0, 229, 255, 0.2);
    transition: box-shadow 0.3s ease-out;
}
.mining-visual {
    position: absolute;
    width: 100%;
    height: 100%;
    border-radius: 50%;
}
.mining-visual::before, .mining-visual::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 95%;
    height: 95%;
    border-radius: 50%;
}
.mining-visual::before {
    border: 2px dashed rgba(0, 229, 255, 0.5);
    animation: rotate-anim 20s linear infinite;
}
.mining-visual::after {
    width: 80%;
    height: 80%;
    border: 2px dotted rgba(255, 215, 0, 0.5);
    animation: rotate-anim 15s linear infinite reverse;
}
@keyframes rotate-anim {
    from { transform: translate(-50%, -50%) rotate(0deg); }
    to { transform: translate(-50%, -50%) rotate(360deg); }
}

.circle.mining-active-glow {animation: pulseGlow 2s infinite alternate;}
@keyframes pulseGlow {
    0% {box-shadow: inset 0 0 40px rgba(0, 229, 255, 0.2), 0 0 30px rgba(0, 229, 255, 0.4), 0 0 60px rgba(0, 229, 255, 0.2);}
    100% {box-shadow: inset 0 0 60px rgba(0, 229, 255, 0.4), 0 0 50px rgba(0, 229, 255, 0.7), 0 0 80px rgba(0, 229, 255, 0.4);}
}
.mining-animation {position:absolute;width:18px;height:18px;background: var(--secondary-glow);border-radius:50%;animation:professionalMineAnim 1.5s ease-out forwards; z-index: 5;}
@keyframes professionalMineAnim {
    0% { transform: translateY(0) scale(0.5); opacity: 1; }
    50% { transform: translateY(-120px) scale(1.5); opacity: 0.8; }
    100% { transform: translateY(-200px) scale(0.5); opacity: 0; }
}
#miningEffectContainer {
    position: absolute;
    width: 100%;
    height: 100%;
    top: 0;
    left: 0;
    overflow: hidden;
    z-index: 5;
}
.mining-increment {
    position: absolute;
    font-size: 24px;
    font-weight: 700;
    color: var(--secondary-glow);
    text-shadow: 0 0 8px rgba(255, 215, 0, 0.7);
    animation: floatUp 1.2s ease-out forwards;
    pointer-events: none;
}
@keyframes floatUp {
    0% { transform: translateY(0); opacity: 1; }
    100% { transform: translateY(-80px); opacity: 0; }
}
button.action-btn{padding:14px 28px;border-radius:30px;font-weight:700;font-size:18px;cursor:pointer;margin-top:20px;transition:0.3s;display: block; margin-left: auto; margin-right: auto; border: none; text-transform: uppercase; letter-spacing: 1px;}
button.action-btn:hover:enabled{filter: brightness(1.2); transform: scale(1.03);}
button.action-btn:disabled{cursor: not-allowed; opacity: 0.6; animation: none;}

.mine-btn, .redeem-btn {
    background: var(--primary-glow);
    color: #000;
    box-shadow: 0 0 8px var(--primary-glow), 0 0 20px var(--primary-glow), 0 0 30px var(--primary-glow);
    animation: pulse-glow-primary 2.5s infinite alternate;
}
.ad-btn, .share-btn, .claim-btn, .withdraw-button {
    background: var(--secondary-glow);
    color: #000;
    box-shadow: 0 0 8px var(--secondary-glow), 0 0 20px var(--secondary-glow), 0 0 30px var(--secondary-glow);
    animation: pulse-glow-secondary 2.5s infinite alternate;
}
.withdrawal-option-btn {
    width: 100%;
    padding: 16px;
    font-size: 20px;
    font-weight: 700;
    letter-spacing: 2px;
    border-radius: 10px;
    border: none;
    cursor: pointer;
    margin-top: 15px;
    transition: all 0.3s ease;
    text-transform: uppercase;
    color: #0D1117;
}

.withdrawal-option-btn:first-child { margin-top: 0; }
.withdrawal-option-btn:hover { transform: translateY(-2px); filter: brightness(1.1); }
.upi-btn { background: var(--primary-glow); box-shadow: 0 0 15px var(--primary-glow), 0 0 25px rgba(0, 229, 255, 0.5); }
.paypal-btn { background: #0070BA; color: white; box-shadow: 0 0 15px #0070BA, 0 0 25px rgba(0, 112, 186, 0.5); }
.crypto-btn { background: #F7931A; box-shadow: 0 0 15px #F7931A, 0 0 25px rgba(247, 147, 26, 0.5); }

@keyframes pulse-glow-primary {
  from { box-shadow: 0 0 8px var(--primary-glow), 0 0 20px var(--primary-glow), 0 0 30px var(--primary-glow); }
  to { box-shadow: 0 0 15px var(--primary-glow), 0 0 35px var(--primary-glow), 0 0 50px var(--primary-glow); }
}
@keyframes pulse-glow-secondary {
  from { box-shadow: 0 0 8px var(--secondary-glow), 0 0 20px var(--secondary-glow), 0 0 30px var(--secondary-glow); }
  to { box-shadow: 0 0 15px var(--secondary-glow), 0 0 35px var(--secondary-glow), 0 0 50px var(--secondary-glow); }
}

.mine-btn { margin-top: 40px; }
#miningCountdown {color: var(--text-light); font-size: 18px; margin-top: 10px; font-weight: 600; text-align: center;}
#adStatus {color: var(--secondary-glow); font-size: 16px; margin-top: 10px; font-weight: 600; text-align: center;}
.wallet-summary, .referral-box, .referral-details, .gift-container, .history-container, .modal-content {
    background: var(--bg-light); padding: 20px; border-radius: 12px; margin: 20px 0;
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.5); border: 1px solid var(--border-color); text-align: center;
}
.balance-info { margin-bottom: 20px; }
.balance-label { font-size: 14px; color: var(--text-dark); }
.balance-value { font-size: 36px; font-weight: 700; color: var(--secondary-glow); }
.value-inr { font-size: 16px; color: var(--primary-glow); margin-top: 5px; }
.withdrawal-note { font-size: 12px; color: var(--text-dark); margin-top: 15px; }
.modal { display: none; position: fixed; z-index: 200; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.8); backdrop-filter: blur(5px); padding-top: 60px; animation: fadeIn 0.3s; }
.close-btn { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer;}
.form-group { margin-bottom: 15px; text-align: left; }
.form-group label { display: block; margin-bottom: 5px; font-weight: 600; color: var(--primary-glow); }
.form-group input { width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 5px; background: var(--bg-dark); color: var(--text-light); }
.form-group input:focus { border-color: var(--primary-glow); outline: none; }
.navbar{
  display:flex; justify-content:space-around; background: rgba(13, 17, 23, 0.7); backdrop-filter: blur(10px);
  padding: 15px 0; border-top: 1px solid var(--border-color); position:fixed; bottom:0; width:100%; z-index:100;
  flex-shrink: 0;
}
.nav-btn{background:none;border:none;color:var(--text-dark);font-size:18px;padding:8px 12px;border-radius:10px;cursor:pointer;transition:0.2s;font-weight:600;}
.nav-btn.active,.nav-btn:hover{ color:var(--primary-glow); text-shadow: 0 0 10px var(--primary-glow); background: rgba(0, 229, 255, 0.1); }
@keyframes fadeIn{from{opacity:0;}to{opacity:1;}}
.history-container { margin-top: 30px; }
.history-container h3 { text-align: center; color: var(--secondary-glow); margin-bottom: 15px; }
.history-table { width: 100%; border-collapse: collapse; }
.history-table th, .history-table td { padding: 10px; text-align: left; border-bottom: 1px solid var(--border-color); }
.history-table th { font-size: 14px; color: var(--text-dark); }
.history-table td { font-size: 15px; }
.status-pending { color: var(--secondary-glow); font-weight: 600; }
.status-approved { color: var(--primary-glow); font-weight: 600; }
.status-rejected { color: #f44336; font-weight: 600; }
.task-item { display: flex; align-items: center; justify-content: space-between; background: var(--bg-dark); padding: 12px 15px; border-radius: 8px; margin-bottom: 10px; cursor: pointer; transition: background-color 0.2s, border-left-color 0.2s; border-left: 4px solid var(--border-color); }
.task-item:hover { background: var(--bg-light); border-left-color: var(--secondary-glow); }
.task-info { display: flex; align-items: center; gap: 15px; overflow: hidden; }
.task-info img { width: 40px; height: 40px; border-radius: 8px; flex-shrink: 0; }
.task-info .task-name { font-weight: 600; color: var(--text-light); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.task-reward { font-weight: 700; font-size: 16px; color: var(--secondary-glow); flex-shrink: 0; padding-left: 10px; }
.verify-btn { width: 100%; padding: 10px; margin-top: -10px; margin-bottom: 10px; border: none; border-radius: 0 0 8px 8px; background: var(--secondary-glow); color: #000; font-weight: 700; cursor: pointer; transition: filter 0.2s; }
.verify-btn:hover { filter: brightness(1.2); }
.task-help-btn { background: none; border: 1px solid var(--border-color); color: var(--text-dark); padding: 8px 16px; font-size: 14px; font-weight: 600; border-radius: 20px; cursor: pointer; display: block; margin: 15px auto 0; transition: all 0.2s ease; }
.task-help-btn:hover { background: var(--border-color); color: var(--text-light); }

.task-nav {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-bottom: 25px;
}
.task-nav-btn {
    background: var(--bg-dark);
    border: 1px solid var(--border-color);
    color: var(--text-dark);
    padding: 8px 20px;
    border-radius: 20px;
    font-weight: 600;
    cursor: pointer;
    font-size: 16px;
    transition: all 0.2s ease;
}
.task-nav-btn.active, .task-nav-btn:hover {
    color: var(--secondary-glow);
    border-color: var(--secondary-glow);
    background: rgba(255, 215, 0, 0.1);
    box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
}
.task-item.premium .task-name {
    color: var(--secondary-glow);
    font-weight: 700;
}
/* === NEW STYLES FOR AD TASK LIST === */
#ad-task-list {
    width: 100%;
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.ad-task-item {
    display: flex;
    align-items: center;
    padding: 12px 15px;
    border-radius: 12px;
    background-color: #3B82F6; /* Default color, will be overridden by JS */
    color: white;
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
}

.ad-task-icon img {
    width: 40px;
    height: 40px;
    margin-right: 15px;
}

.ad-task-info {
    flex-grow: 1;
}

.ad-task-info .title {
    font-weight: 700;
    font-size: 1.1em;
}

.ad-task-info .limit {
    font-size: 0.9em;
    opacity: 0.8;
}

.ad-task-button button {
    background-color: white;
    color: #333;
    border: none;
    border-radius: 8px;
    padding: 10px 20px;
    font-weight: 700;
    cursor: pointer;
    transition: background-color 0.2s, transform 0.2s;
    min-width: 80px;
    text-align: center;
}

.ad-task-button button:hover:enabled {
    background-color: #f0f0f0;
    transform: scale(1.05);
}

.ad-task-button button:disabled {
    background-color: #ccc;
    color: #666;
    cursor: not-allowed;
}

</style>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
<div id="app-content" style="width: 100%; height: 100%; display: flex; flex-direction: column;">
    <header>
    <div class="profile" onclick="showProfile()">
    <img id="profile-img" src="https://i.pravatar.cc/45" alt="Profile">
    <span id="username">Loading...</span> </div>
    <div class="msg-icon" onclick="showMsg()">üí¨</div>
    </header>
    <main>
    <section id="home" class="section">
    <div id="totalCoins"><span id="coinCount">0</span></div>
    <h2>Your Coins</h2>
    <div class="circle-container">
    <div class="circle" id="mineCircle">
        <div class="mining-visual"></div>
        <div id="miningEffectContainer"></div>
    </div>
    </div>
    <button class="action-btn ad-btn" id="watchAdBtn" onclick="watchAd()">üé¨ Watch Ad</button>
    <div id="adStatus">Ads Watched: 0/10</div>
    <button class="action-btn mine-btn" id="mineBtn" onclick="startDailyMining()">ü™ô Start Mining</button>
    <div id="miningCountdown">Click to start 1 hour session</div>
    </section>

    <section id="task" class="section">
        <div id="taskList">
            <div class="task-nav">
                <button class="task-nav-btn active" onclick="showTaskCategory('daily', this)">üß© Daily</button>
                <button class="task-nav-btn" onclick="showTaskCategory('premium', this)">‚≠ê Premium</button>
            </div>

            <div id="daily-tasks">
                <p style="margin-bottom: 25px; color:#aaa; text-align: center;">Complete simple tasks and earn rewards.</p>
                <div id="task-items-container">
                    <p style="text-align: center; color: #777; margin-top: 50px;">Loading tasks...</p>
                </div>
            </div>

            <div id="premium-tasks" style="display: none;">
                <p style="padding: 12px 15px; text-align: center; color: var(--secondary-glow); font-weight: 600; background: rgba(255, 215, 0, 0.08); border: 1px solid rgba(255, 215, 0, 0.2); border-radius: 8px; margin-bottom: 25px;">
                    Complete one premium task earn more coins and unlimited withdrawal access
                </p>
                <div id="premium-task-items-container">
                    <p style="text-align: center; color: #777; margin-top: 50px;">Loading premium tasks...</p>
                </div>
            </div>
        </div>
    </section>

    <section id="watch" class="section">
        <h2 style="text-align: center; color: var(--primary-glow); margin-bottom: 25px;">Watch Ads & Earn Coins</h2>
        <div id="ad-task-list">
            <p style="text-align: center; color: #777;">Loading Ad Tasks...</p>
        </div>
    </section>

    <section id="wallet" class="section">
        <div style="display: flex; justify-content: center; align-items: center; position: relative; margin-bottom: 10px;">
            <h2 style="text-align: center; margin: 0;">üíº Wallet</h2>
            <a id="customerCareLink" title="Contact Support" style="position: absolute; right: 0; top: 50%; transform: translateY(-50%); font-size: 28px; text-decoration: none; cursor: pointer;">üéß</a>
        </div>
        <div class="wallet-summary">
            <div class="balance-info">
                <div class="balance-label">Current Balance (Coins)</div>
                <div class="balance-value"><span id="walletCoins">0</span></div>
                <div class="value-inr">‚Çπ <span id="walletValue">0.00</span> (3000 Coins ‚âà ‚Çπ1)</div>
            </div>
            <div class="withdrawal-options">
                <button class="withdrawal-option-btn upi-btn" onclick="showWithdrawalModal()">UPI</button>
                <button class="withdrawal-option-btn paypal-btn" onclick="showPaypalModal()">PAYPAL</button>
                <button class="withdrawal-option-btn crypto-btn" onclick="showCryptoModal()">CRYPTO</button>
            </div>
            <div class="withdrawal-note">
                Minimum UPI withdrawal: <strong>30,000 Coins</strong>.<br>
                Minimum International withdrawal: <strong>100,000 Coins</strong>.
            </div>
        </div>
        <div class="history-container">
            <h3>Withdrawal History</h3>
            <div style="max-height: 300px; overflow-y: auto;">
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Amount</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="withdrawal-history-table">
                    </tbody>
                </table>
            </div>
        </div>
    </section>

    </main>

    <nav class="navbar">
    <button class="nav-btn active" onclick="showSection('home', this)">üè† Home</button>
    <button class="nav-btn" onclick="showSection('task', this)">üß© Task</button>
    <button class="nav-btn" onclick="showSection('watch', this)">üì∫ Watch</button>
    <button class="nav-btn" onclick="showSection('wallet', this)">üíº Wallet</button>
    </nav>
</div>
<div id="withdrawalModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeWithdrawalModal()">&times;</span>
        <h3>UPI Withdrawal</h3>
        <p style="color:#aaa; text-align: center; margin-bottom: 15px;">Minimum: 30,000 Coins</p>
        <div class="form-group">
            <label for="upiAmount">Coins to Withdraw:</label>
            <input type="number" id="upiAmount" placeholder="Min 30000" oninput="checkWithdrawalEligibility()">
            <small id="inrValueText" style="color: var(--primary-glow);"></small>
        </div>
        <div class="form-group">
            <label for="upiId">Your UPI ID:</label>
            <input type="text" id="upiId" placeholder="example@bankupi">
        </div>
        <button class="withdraw-button" id="submitWithdrawalBtn" disabled onclick="submitWithdrawal()">Submit Withdrawal Request</button>
        <small style="display: block; text-align: center; color: #f44336; margin-top: 10px;">Withdrawals processed within 24 hours.</small>
    </div>
</div>
<div id="paypalModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closePaypalModal()">&times;</span>
        <h3>PayPal Withdrawal</h3>
        <p style="color:#aaa; text-align: center; margin-bottom: 15px;">Minimum: 100,000 Coins</p>
        <div class="form-group">
            <label for="paypalAmount">Coins to Withdraw:</label>
            <input type="number" id="paypalAmount" placeholder="Min 100000" oninput="checkPaypalEligibility()">
        </div>
        <div class="form-group">
            <label for="paypalEmail">Your PayPal Email:</label>
            <input type="email" id="paypalEmail" placeholder="example@email.com">
        </div>
        <button class="withdraw-button" id="submitPaypalBtn" disabled onclick="submitPaypalWithdrawal()">Submit Withdrawal Request</button>
        <small style="display: block; text-align: center; color: #f44336; margin-top: 10px;">Withdrawals processed within 48 hours.</small>
    </div>
</div>
<div id="cryptoModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeCryptoModal()">&times;</span>
        <h3>Crypto (USDT) Withdrawal</h3>
        <p style="color:#aaa; text-align: center; margin-bottom: 15px;">Minimum: 100,000 Coins</p>
         <p style="color:var(--secondary-glow); font-size: 12px; text-align: center; margin-bottom: 15px;">Network: TRC20 (Tron). Sending to other networks will result in loss of funds.</p>
        <div class="form-group">
            <label for="cryptoAmount">Coins to Withdraw:</label>
            <input type="number" id="cryptoAmount" placeholder="Min 100000" oninput="checkCryptoEligibility()">
        </div>
        <div class="form-group">
            <label for="cryptoAddress">Your USDT (TRC20) Wallet Address:</label>
            <input type="text" id="cryptoAddress" placeholder="T...">
        </div>
        <button class="withdraw-button" id="submitCryptoBtn" disabled onclick="submitCryptoWithdrawal()">Submit Withdrawal Request</button>
        <small style="display: block; text-align: center; color: #f44336; margin-top: 10px;">Withdrawals processed within 48 hours.</small>
    </div>
</div>
<div id="taskDetailModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" id="closeTaskModal">&times;</span>
        <h3 id="taskDetailTitle" style="color: var(--primary-glow); margin-bottom: 5px;">Task Details</h3>
        <p style="font-weight: 600; margin-bottom: 15px;">Reward: <span id="taskDetailReward" style="color: var(--secondary-glow);"></span></p>
        <p style="font-size: 14px; color: #ccc; margin-top: 10px;">Instructions:</p>
        <ul id="taskDetailInstructions" class="referral-instruction-list" style="margin-bottom: 20px;">
        </ul>
        <button id="taskDetailCompleteBtn" class="action-btn" style="width: 100%; margin: 20px 0 0 0; background: var(--primary-glow); color: #000;">Download</button>
        <button class="task-help-btn" onclick="Telegram.WebApp.openTelegramLink('https://t.me/MiningFatherhelp')">‚ùì Need Help?</button>
    </div>
</div>
<!-- ===== START: NEW WITHDRAWAL ADS MODAL ===== -->
<div id="withdrawalAdsModal" class="modal">
    <div class="modal-content">
        <h3>Watch Ads to Withdraw</h3>
        <p style="color:#aaa; text-align: center; margin-bottom: 20px;">Please watch 10 ads to complete your withdrawal request.</p>
        <button class="action-btn ad-btn" id="watchWithdrawalAdBtn" onclick="watchWithdrawalAd()" style="width: 100%;">
            üé¨ Watch Ad
        </button>
        <div id="withdrawalAdStatus" style="color: var(--text-light); font-size: 18px; margin-top: 20px; font-weight: 600; text-align: center;">
            Ads Watched: 0/10
        </div>
    </div>
</div>
<!-- ===== END: NEW WITHDRAWAL ADS MODAL ===== -->
<audio id="preMiningSound" src="pre-mining.mp3" preload="auto" loop></audio>
<audio id="miningSound" src="mining.mp3" preload="auto" loop></audio>
<audio id="clickSound" src="click.mp3" preload="auto"></audio>
<audio id="successSound" src="success.mp3" preload="auto"></audio>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, set, onValue, update, push, get, query, orderByChild, equalTo, remove } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

const WebApp = window.Telegram.WebApp;
WebApp.ready();
WebApp.expand();

// Safely get Telegram user data
let telegramUser = null;
try {
    telegramUser = WebApp.initDataUnsafe.user;
    if (!telegramUser || !telegramUser.id) {
        WebApp.showAlert("Could not verify your Telegram account. Please try restarting the app through Telegram.", () => WebApp.close());
        throw new Error("Missing Telegram User ID");
    }
} catch (error) {
    console.error("Critical Error: Could not get Telegram user data.", error);
    WebApp.showAlert("A critical error occurred while loading your profile. Please restart the app.", () => WebApp.close());
    throw new Error("App halted due to missing user data.");
}

const TELEGRAM_USER_ID = telegramUser.id.toString();
const USER_NAME = telegramUser.first_name + (telegramUser.last_name ? ' ' + telegramUser.last_name : '');
document.getElementById('username').innerText = USER_NAME;


// Firebase Configuration
const firebaseConfig = {
    apiKey: "AIzaSyCcgl31JqffVd8bW8G23UurFhxH8IFlEfM",
    authDomain: "mining-bot-276d0.firebaseapp.com",
    projectId: "mining-bot-276d0",
    storageBucket: "mining-bot-276d0.firebasestorage.app",
    messagingSenderId: "263688973305",
    appId: "1:263688973305:web:bf3eab880a03dde0ec2b28",
    measurementId: "G-2FWW2SVSLR"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const database = getDatabase(app);

// Database References
const DB_NODE_PATH = 'users/' + TELEGRAM_USER_ID;
const ADMIN_SETTINGS_REF = ref(database, 'admin_settings');
const TASKS_REF = ref(database, 'tasks');
const WITHDRAWALS_REF = ref(database, 'withdrawals');
const GLOBAL_POPUP_REF = ref(database, 'global_popup');
const WITHDRAWAL_SETTINGS_REF = ref(database, 'withdrawal_settings');

// Global State Variables
window.coins = 0;
window.dailyMinedTimestamp = 0;
window.miningEndTime = 0;
window.adsWatched = 0;
window.adsWatchedTimestamp = 0;
window.adTaskProgress = {};
let allAdTasks = {};
window.dbRef = ref(database, DB_NODE_PATH);
let miningInterval = null;
let remainingTimeInterval = null;
let incrementCounter = 0;
let COINS_PER_INCREMENT = 0.1;
const MINING_RATE_MS = 450; 
const INTL_COINS_PER_INCREMENT = 0.125; 
const ONE_HOUR_MS = 60 * 60 * 1000;
const TWO_HOURS_MS = 2 * 60 * 60 * 1000;
const MIN_WITHDRAWAL_COINS = 30000; 
const MIN_INTL_WITHDRAWAL_COINS = 100000;
window.ADS_REQUIRED = 10;
window.AD_REWARD_COINS = 5;
const WITHDRAWAL_ADS_REQUIRED = 5;
let withdrawalAdsWatched = 0;
let isInitialLoadComplete = false;
let withdrawalSettings = {
    upi: { locked: false, message: '' },
    paypal: { locked: false, message: '' },
    crypto: { locked: false, message: '' }
};
let userCountry = ''; 

// DOM Elements
const mineButton = document.getElementById('mineBtn');
const watchAdBtn = document.getElementById('watchAdBtn');
const adStatusDisplay = document.getElementById('adStatus');
const mineCircle = document.getElementById('mineCircle');
const miningEffectContainer = document.getElementById('miningEffectContainer');
const countdownDisplay = document.getElementById('miningCountdown');
const withdrawalModal = document.getElementById('withdrawalModal');
const submitWithdrawalBtn = document.getElementById('submitWithdrawalBtn');
const taskDetailModal = document.getElementById('taskDetailModal');
const closeTaskModalBtn = document.getElementById('closeTaskModal');
let allTasks = {};
const paypalModal = document.getElementById('paypalModal');
const cryptoModal = document.getElementById('cryptoModal');
const submitPaypalBtn = document.getElementById('submitPaypalBtn');
const submitCryptoBtn = document.getElementById('submitCryptoBtn');
const preMiningSound = document.getElementById('preMiningSound');
const miningSound = document.getElementById('miningSound');
const clickSound = document.getElementById('clickSound');
const successSound = document.getElementById('successSound');

let hasInteracted = false;

function primeAudio() {
    if (hasInteracted) return;
    hasInteracted = true;
    [preMiningSound, miningSound, clickSound, successSound].forEach(sound => {
        sound.play().then(() => sound.pause()).catch(() => {});
    });
}
function playClickSound() { if (hasInteracted) { clickSound.currentTime = 0; clickSound.play().catch(e => {}); }}
function playSuccessSound() { if (hasInteracted) { successSound.currentTime = 0; successSound.play().catch(e => {}); }}
function stopAllMiningSounds() {
    preMiningSound.pause(); preMiningSound.currentTime = 0;
    miningSound.pause(); miningSound.currentTime = 0;
}
function updateSoundState() {
    if (!hasInteracted) return;
    const miningIsActive = window.miningEndTime > Date.now();
    const isReadyToMine = window.canMineAgain() && window.adsWatched >= window.ADS_REQUIRED;
    const homeSectionIsVisible = document.getElementById('home').style.display !== 'none';

    if (miningIsActive) {
        if (miningSound.paused) { preMiningSound.pause(); preMiningSound.currentTime = 0; miningSound.play().catch(e => {}); }
    } else if (homeSectionIsVisible && isReadyToMine) {
        if (preMiningSound.paused) { miningSound.pause(); miningSound.currentTime = 0; preMiningSound.play().catch(e => {}); }
    } else {
        stopAllMiningSounds();
    }
}

async function getUserCountry() {
    const storedCountry = localStorage.getItem('userCountryCode');
    if (storedCountry) {
        userCountry = storedCountry; 
        return storedCountry;
    }
    try {
        const response = await fetch('https://ipapi.co/json/');
        if (!response.ok) throw new Error('Network response was not ok');
        const data = await response.json();
        const countryCode = data.country_code;
        if (countryCode) {
            localStorage.setItem('userCountryCode', countryCode);
            userCountry = countryCode; 
            return countryCode;
        }
        return null;
    } catch (error) {
        console.error("Could not fetch user country:", error);
        return null;
    }
}

function loadUserData() {
    onValue(window.dbRef, async (snapshot) => {
        let data = snapshot.val();
        if (!data) {
            console.log("New user detected. Creating profile...");
            const newUserCountry = await getUserCountry();
            const initialData = {
                coins: 0, dailyMinedTimestamp: 0, miningEndTime: 0, adsWatched: 0,
                adsWatchedTimestamp: 0, upiId: '', telegramId: TELEGRAM_USER_ID,
                userName: USER_NAME, lastActive: Date.now(), joinDate: Date.now(),
                country: newUserCountry || 'N/A',
                adTaskProgress: {}
            };
            
            try {
                await set(window.dbRef, initialData);
                console.log("User profile created successfully in Firebase.");
                updateGlobalState(initialData); 
            } catch (error) {
                console.error("Firebase Write Error (User Creation):", error);
                WebApp.showAlert("Failed to create your profile. Please check your internet connection and restart the app. Error: " + error.message);
            }
            return;
        }
        
        userCountry = data.country;
        if (data.country && data.country !== 'IN') COINS_PER_INCREMENT = INTL_COINS_PER_INCREMENT;
        else COINS_PER_INCREMENT = 0.1;
        
        const updates = { lastActive: Date.now(), userName: USER_NAME };
        const fetchedCountry = await getUserCountry();
        if (fetchedCountry && data.country !== fetchedCountry) updates.country = fetchedCountry;

        if (!isInitialLoadComplete) {
            isInitialLoadComplete = true; 
            const lastSeen = data.lastActive || 0;
            const sessionStartTime = data.dailyMinedTimestamp || 0;
            const sessionEndTime = data.miningEndTime || 0;
            const now = Date.now();
            let offlineCoinsEarned = 0;

            if (sessionStartTime > 0 && sessionEndTime > lastSeen) {
                const calculationStartTime = Math.max(lastSeen, sessionStartTime);
                const calculationEndTime = Math.min(now, sessionEndTime);
                const offlineDurationMs = calculationEndTime - calculationStartTime;

                if (offlineDurationMs > 0) {
                    const incrementsMissed = Math.floor(offlineDurationMs / MINING_RATE_MS);
                    const coinsPerIncrementForOffline = (data.country && data.country !== 'IN') ? INTL_COINS_PER_INCREMENT : 0.1;
                    offlineCoinsEarned = incrementsMissed * coinsPerIncrementForOffline;
                    
                    if (offlineCoinsEarned > 0) {
                        data.coins = (parseFloat(data.coins) || 0) + offlineCoinsEarned;
                        updates.coins = data.coins; 
                        const historyRef = push(ref(database, `users/${TELEGRAM_USER_ID}/coin_history`));
                        updates[`coin_history/${historyRef.key}`] = { 
                            reason: 'Offline Mining', 
                            amount: parseFloat(offlineCoinsEarned.toFixed(3)), 
                            timestamp: Date.now() 
                        };
                    }
                }
            }
        }
        
        updateGlobalState(data); 

        if (Object.keys(updates).length > 2 || (updates.country && data.country !== updates.country) || 'coins' in updates) {
             update(window.dbRef, updates);
        }

        processDataForStateUpdate();

    }, (error) => {
        console.error("Firebase Read Error (User Data):", error);
        WebApp.showAlert("Failed to load your data. Please check your internet connection and restart. Error: " + error.message);
    });
}
function listenForNotifications() {
    const notificationRef = ref(database, `users/${TELEGRAM_USER_ID}/notifications`);
    onValue(notificationRef, (snapshot) => {
        if (snapshot.exists()) {
            const notification = snapshot.val();
            WebApp.showPopup({ message: notification.message });
            remove(notificationRef);
        }
    });
}
function listenForAdminPopups() {
    const userPopupRef = ref(database, `users/${TELEGRAM_USER_ID}/popup`);
    onValue(userPopupRef, (snapshot) => {
        if (snapshot.exists()) {
            const popupData = snapshot.val();
            WebApp.showPopup({
                title: popupData.title, message: popupData.message,
                buttons: [{ type: 'ok', text: 'Close' }]
            });
            remove(userPopupRef);
        }
    });
    onValue(GLOBAL_POPUP_REF, (snapshot) => {
        if (snapshot.exists()) {
            const popupData = snapshot.val();
            const lastShownTimestamp = localStorage.getItem('lastGlobalPopupTimestamp') || 0;
            if (popupData.timestamp > lastShownTimestamp) {
                WebApp.showPopup({
                    title: popupData.title, message: popupData.message,
                    buttons: [{ type: 'ok', text: 'Got it!' }]
                });
                localStorage.setItem('lastGlobalPopupTimestamp', popupData.timestamp);
            }
        }
    });
}
function loadAdminSettings() {
    onValue(ADMIN_SETTINGS_REF, (snapshot) => {
        const settings = snapshot.val();
        if (settings) {
            window.ADS_REQUIRED = settings.miningAds?.required || 10;
            window.AD_REWARD_COINS = settings.adTasks?.reward || 5;
            allAdTasks = settings.adTasks || {};
            loadAdTasks();
            updateMiningButtonState();
            updateAdStatus();
        }
    }, (error) => console.error("Firebase Read Error (Admin Settings):", error));
}

function loadWithdrawalLockSettings() {
    onValue(WITHDRAWAL_SETTINGS_REF, (snapshot) => {
        if (snapshot.exists()) {
            withdrawalSettings = snapshot.val();
        }
    }, (error) => {
        console.error("Firebase Read Error (Withdrawal Settings):", error);
    });
}

async function loadLiveTasks() {
    const dailyTaskContainer = document.getElementById('task-items-container');
    const premiumTaskContainer = document.getElementById('premium-task-items-container');
    if (!userCountry) userCountry = await getUserCountry();
    if (!userCountry) {
        const errorMsg = '<p style="text-align: center; color: #777; margin-top: 50px;">Could not determine your location to show relevant tasks.</p>';
        dailyTaskContainer.innerHTML = errorMsg;
        premiumTaskContainer.innerHTML = errorMsg;
        return;
    }
    const userTasksRef = ref(database, `users/${TELEGRAM_USER_ID}`);
    const userSnapshot = await get(userTasksRef);
    const userData = userSnapshot.val() || {};
    const startedTasks = userData.startedTasks || {};
    const completedTasks = userData.completedTasks || {};
    onValue(TASKS_REF, (snapshot) => {
        dailyTaskContainer.innerHTML = '';
        premiumTaskContainer.innerHTML = '';
        const tasks = snapshot.val();
        allTasks = tasks;
        let dailyTaskHtml = '';
        let premiumTaskHtml = '';
        let activeDailyTasksFound = false;
        let activePremiumTasksFound = false;

        if (tasks) {
            for (const taskId in tasks) {
                const task = tasks[taskId];
                const isCountryMatch = !task.countries || task.countries.length === 0 || task.countries.includes(userCountry);
                if (task.active && isCountryMatch) {
                    const isCompleted = completedTasks[taskId];
                    const startStatus = startedTasks[taskId];
                    let actionButton = '';
                    if (isCompleted) {
                        actionButton = `<button class="verify-btn" style="background: #4caf50; color: white;" disabled>‚úÖ Completed</button>`;
                    } else if (startStatus === 'pending') {
                        actionButton = `<button class="verify-btn" style="background: #808080;" disabled>‚è≥ Pending Verification</button>`;
                    } else if (typeof startStatus === 'number') {
                        const ONE_MINUTE_MS = 60 * 1000;
                        const timeSinceStart = Date.now() - startStatus;
                        if (timeSinceStart < ONE_MINUTE_MS) {
                            actionButton = `<button class="verify-btn" style="background: #808080;" disabled>Please wait 1 min</button>`;
                        } else {
                            actionButton = `<button class="verify-btn" onclick="verifyTask('${taskId}', '${task.name}')">Verify Task</button>`;
                        }
                    } else {
                        actionButton = `<button class="verify-btn" onclick="verifyTask('${taskId}', '${task.name}')" style="display:none;"></button>`;
                    }
                    
                    const taskItemHtml = `
                        <div class="task-item-wrapper">
                            <div class="task-item ${task.isPremium ? 'premium' : ''}" onclick="showTaskDetails('${taskId}')">
                                <div class="task-info">
                                    <img src="${task.logoUrl || 'https://via.placeholder.com/40'}" alt="task logo">
                                    <span class="task-name">${task.name}</span>
                                </div>
                                <div class="task-reward">${task.reward.toLocaleString()} C</div>
                            </div>
                            ${actionButton}
                        </div>`;
                    
                    if (task.isPremium) {
                        activePremiumTasksFound = true;
                        premiumTaskHtml += taskItemHtml;
                    } else {
                        activeDailyTasksFound = true;
                        dailyTaskHtml += taskItemHtml;
                    }
                }
            }
        }
        if (activeDailyTasksFound) {
            dailyTaskContainer.innerHTML = dailyTaskHtml;
        } else {
            dailyTaskContainer.innerHTML = '<p style="text-align: center; color: #777; margin-top: 50px;">No daily tasks available right now. Check back later!</p>';
        }
        if (activePremiumTasksFound) {
            premiumTaskContainer.innerHTML = premiumTaskHtml;
        } else {
            premiumTaskContainer.innerHTML = '<p style="text-align: center; color: #777; margin-top: 50px;">No premium tasks available right now. Check back later!</p>';
        }

    }, { onlyOnce: true });
}

window.showTaskDetails = (taskId) => {
    const task = allTasks[taskId];
    if (!task) return;
    document.getElementById('taskDetailTitle').innerText = task.name;
    document.getElementById('taskDetailReward').innerText = `${task.reward.toLocaleString()} Coins`;
    document.getElementById('taskDetailInstructions').innerHTML = task.instructions.map(inst => `<li>${inst}</li>`).join('');
    const completeBtn = document.getElementById('taskDetailCompleteBtn');
    completeBtn.onclick = () => startTask(taskId, task.link);
    taskDetailModal.style.display = 'block';
}
function closeTaskModal() { taskDetailModal.style.display = 'none'; }
window.startTask = (taskId, taskLink) => {
    const userTaskStatusRef = ref(database, `users/${TELEGRAM_USER_ID}/startedTasks/${taskId}`);
    set(userTaskStatusRef, Date.now()).then(() => {
        sessionStorage.setItem('awaitingVerificationPopup', 'true');
        closeTaskModal();
        WebApp.openLink(taskLink);
        loadLiveTasks();
    }).catch(error => {
        WebApp.showAlert("Could not start the task. Please try again.");
        console.error("Error starting task:", error);
    });
};
window.verifyTask = (taskId, taskName) => {
    const verificationsRef = ref(database, 'task_verifications');
    const newVerificationRef = push(verificationsRef);
    set(newVerificationRef, {
        userId: TELEGRAM_USER_ID, userName: USER_NAME, taskId: taskId,
        taskName: taskName, timestamp: Date.now(), status: 'pending'
    }).then(() => {
        WebApp.showAlert("Your task has been submitted for verification. Please wait for it to be approved by an admin.");
        const userTaskStatusRef = ref(database, `users/${TELEGRAM_USER_ID}/startedTasks/${taskId}`);
        set(userTaskStatusRef, 'pending');
        loadLiveTasks();
    }).catch((error) => {
        WebApp.showAlert("Could not submit task for verification. Please try again.");
        console.error("Verification submission error: ", error);
    });
};
closeTaskModalBtn.onclick = closeTaskModal;
function loadWithdrawalHistory() {
    const historyTableBody = document.getElementById('withdrawal-history-table');
    const userWithdrawalsQuery = query(WITHDRAWALS_REF, orderByChild('userId'), equalTo(TELEGRAM_USER_ID));
    onValue(userWithdrawalsQuery, (snapshot) => {
        historyTableBody.innerHTML = '';
        if (!snapshot.exists()) {
            historyTableBody.innerHTML = `<tr><td colspan="3" style="text-align:center; color: #888;">No history found.</td></tr>`;
            return;
        }
        const withdrawals = [];
        snapshot.forEach(childSnapshot => { withdrawals.push(childSnapshot.val()); });
        withdrawals.sort((a, b) => b.timestamp - a.timestamp);
        withdrawals.forEach(data => {
            const date = new Date(data.timestamp).toLocaleDateString();
            const statusClass = `status-${data.status.toLowerCase()}`;
            const row = `<tr><td>${date}</td><td>${data.amount.toLocaleString()}</td><td class="${statusClass}">${data.status}</td></tr>`;
            historyTableBody.innerHTML += row;
        });
    });
}
function updateGlobalState(data) {
    // BUG FIX (Robust): Ensure coins is always a number. If it's NaN or undefined from DB, reset to 0.
    window.coins = parseFloat(data.coins) || 0;
    
    window.dailyMinedTimestamp = data.dailyMinedTimestamp || 0;
    window.miningEndTime = data.miningEndTime || 0;
    window.adsWatched = data.adsWatched || 0;
    window.adsWatchedTimestamp = data.adsWatchedTimestamp || 0;
    window.upiId = data.upiId || '';
    window.adTaskProgress = data.adTaskProgress || {};
}
function processDataForStateUpdate() {
    if (window.miningEndTime > Date.now()) { resumeMiningSession(); }
    else { stopMining(false); }
    if (window.dailyMinedTimestamp !== 0 && window.canMineAgain()) {
        const updates = { dailyMinedTimestamp: 0, adsWatched: 0, adsWatchedTimestamp: 0 };
        updateDatabase(updates);
        window.dailyMinedTimestamp = 0; window.adsWatched = 0; window.adsWatchedTimestamp = 0;
    }
    
    updateCoinDisplays();
    updateMiningButtonState();
    loadAdTasks();
}
window.updateDatabase = (updates) => {
    update(window.dbRef, updates).catch(error => console.error("Database Write Error:", error));
};
function updateCoinDisplays() {
    // BUG FIX (Robust): Ensure coins is a valid number before displaying
    const currentCoins = parseFloat(window.coins) || 0;
    const inrValue = (currentCoins / 3000).toFixed(2);
    const coinsStr = Math.floor(currentCoins).toLocaleString();
    
    document.getElementById('coinCount').innerText = coinsStr;
    document.getElementById('walletCoins').innerText = coinsStr;
    document.getElementById('walletValue').innerText = inrValue;
}
function formatTime(ms) {
    if (ms < 0) ms = 0;
    const seconds = Math.floor((ms / 1000) % 60);
    const minutes = Math.floor((ms / (1000 * 60)) % 60);
    const hours = Math.floor((ms / (1000 * 60 * 60)) % 24);
    return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
}
window.canMineAgain = () => { return (Date.now() - window.dailyMinedTimestamp) >= TWO_HOURS_MS; }

window.watchAd = () => {
    // 1. Basic Checks (Mining active or Cooldown)
    const miningStillActive = window.miningEndTime > Date.now();
    const isInCooldown = !window.canMineAgain() && window.dailyMinedTimestamp !== 0;
    
    if (window.adsWatched >= window.ADS_REQUIRED) {
        WebApp.showAlert(window.canMineAgain() ? "A new session is ready. Click 'Start Mining'." : "Ads are complete. Wait for the 2h reset.");
        return;
    }
    
    if (miningStillActive || isInCooldown) {
        WebApp.showAlert("Cannot watch ads while mining or in cooldown.");
        return;
    }

    // 2. Button Update
    const watchAdBtn = document.getElementById('watchAdBtn');
    watchAdBtn.disabled = true;
    watchAdBtn.innerText = 'üé• Loading Monetag Ad...';

    // === MONETAG LOGIC STARTS HERE ===
    // Check if Monetag function exists (Make sure ID matches your head tag)
    if (typeof show_9969043 === 'undefined') {
        console.error("Monetag SDK not loaded.");
        WebApp.showAlert("Ad failed to load. Please check internet.");
        watchAdBtn.disabled = false;
        watchAdBtn.innerText = 'üé¨ Watch Ad';
        return;
    }

    // Call Monetag Ad
    show_9969043('pop').then(() => {
        // --- SUCCESS LOGIC ---
        const newWatchedCount = window.adsWatched + 1;
        const currentCoins = parseFloat(window.coins) || 0;
        const rewardCoins = parseFloat(window.AD_REWARD_COINS) || 5;
        
        const updates = {
            coins: currentCoins + rewardCoins,
            adsWatched: newWatchedCount,
            adsWatchedTimestamp: Date.now()
        };
        const historyRef = push(ref(database, `users/${TELEGRAM_USER_ID}/coin_history`));
        updates[`coin_history/${historyRef.key}`] = {
            reason: 'Ad Reward (Mining)', amount: rewardCoins, timestamp: Date.now()
        };

        update(window.dbRef, updates).then(() => {
            if (newWatchedCount < window.ADS_REQUIRED) {
                WebApp.showPopup({ message: `+${rewardCoins} Coins! ${window.ADS_REQUIRED - newWatchedCount} more ads needed.` });
            } else {
                WebApp.showPopup({ message: `Congratulations! You can now start mining!` });
            }
            playSuccessSound();
            loadUserData();
        });
    }).catch((e) => {
        // --- ERROR LOGIC ---
        console.error("Monetag Error:", e);
        WebApp.showAlert("Ad was skipped or failed.");
    }).finally(() => {
        // Reset Button
         if (window.adsWatched < window.ADS_REQUIRED) {
            watchAdBtn.disabled = false;
            watchAdBtn.innerText = 'üé¨ Watch Ad';
        }
    });
    // === MONETAG LOGIC ENDS ===
}

function updateAdStatus() {
    const isInCooldown = !window.canMineAgain() && window.dailyMinedTimestamp !== 0;
    if (window.adsWatched >= window.ADS_REQUIRED) {
        adStatusDisplay.innerText = `Ads Complete! Mining unlocked.`;
        watchAdBtn.disabled = true; watchAdBtn.innerText = '‚úÖ Ads Complete';
        if (isInCooldown) {
            const remainingCooldown = (window.dailyMinedTimestamp + TWO_HOURS_MS) - Date.now();
            adStatusDisplay.innerHTML = `Ads/Mining Reset in: ${formatTime(remainingCooldown)}`;
        }
    } else {
        adStatusDisplay.innerText = `Ads Watched: ${window.adsWatched}/${window.ADS_REQUIRED}`;
        watchAdBtn.disabled = isInCooldown; watchAdBtn.innerText = 'üé¨ Watch Ad';
    }
}
function startMiningAnimation(){
  const numParticles = Math.floor(Math.random() * 2) + 1;
  for(let i=0;i<numParticles;i++){
    const anim=document.createElement('div'); anim.className='mining-animation';
    anim.style.left=(Math.random() * 50 + 25) +'%'; anim.style.top=(Math.random() * 40 + 30) + '%';
    mineCircle.appendChild(anim); setTimeout(()=>mineCircle.removeChild(anim), 1500);
  }
}
function showMiningIncrement() {
    if (!miningEffectContainer) return;
    const incrementEl = document.createElement('span'); incrementEl.className = 'mining-increment';
    incrementEl.innerText = `+${COINS_PER_INCREMENT.toFixed(3).replace(/0+$/, '').replace(/\.$/, '')}`;
    const xPos = Math.random() * 50 + 25; const yPos = Math.random() * 40 + 40;
    incrementEl.style.left = `${xPos}%`; incrementEl.style.top = `${yPos}%`;
    miningEffectContainer.appendChild(incrementEl); setTimeout(() => { incrementEl.remove(); }, 1200);
}
window.stopMining = (doUpdateState = true) => {
    clearInterval(miningInterval); clearInterval(remainingTimeInterval);
    if(miningEffectContainer) miningEffectContainer.innerHTML = '';
    miningInterval = null; remainingTimeInterval = null;
    mineCircle.classList.remove('mining-active-glow');
    if (window.miningEndTime !== 0) {
        window.miningEndTime = 0;
        if(doUpdateState) { window.updateDatabase({ miningEndTime: 0, coins: window.coins }); }
    }
    if (doUpdateState) updateMiningButtonState();
    updateSoundState();
}
function updateCountdown() {
    const remainingSessionTime = window.miningEndTime - Date.now();
    if (remainingSessionTime <= 0) { stopMining(); return; }
    mineCircle.classList.add('mining-active-glow');
    mineButton.disabled = true; mineButton.innerText = '‚õèÔ∏è Mining Active'; mineButton.style.background = '#808080';
    countdownDisplay.innerText = 'Time Left: ' + formatTime(remainingSessionTime);
}
function resumeMiningSession() {
    if (miningInterval) return;
    updateSoundState();
    const remainingTime = window.miningEndTime - Date.now();
    if (remainingTime <= 0) return;
    clearInterval(miningInterval); clearInterval(remainingTimeInterval);
    incrementCounter = 0;
    
    miningInterval = setInterval(() => {
        // BUG FIX (Robust): Ensure coins is a number before incrementing
        window.coins = (parseFloat(window.coins) || 0) + COINS_PER_INCREMENT;
        incrementCounter++;
        if (incrementCounter % 20 === 0) {
            const updates = { coins: window.coins };
            window.updateDatabase(updates);
        }
        startMiningAnimation();
        showMiningIncrement();
        updateCoinDisplays();
    }, MINING_RATE_MS);
    remainingTimeInterval = setInterval(updateCountdown, 1000);
    updateCountdown();
}
window.startDailyMining = () => {
  if (window.adsWatched < window.ADS_REQUIRED) { WebApp.showAlert(`Please watch ${window.ADS_REQUIRED} ads to start mining.`); return; }
  if (miningInterval) return;
  if (!window.canMineAgain()){ startCooldownCountdown(); return; }
  const currentTime = Date.now(); const endTime = currentTime + ONE_HOUR_MS;
  window.dailyMinedTimestamp = currentTime; window.miningEndTime = endTime;
  window.updateDatabase({ dailyMinedTimestamp: currentTime, miningEndTime: endTime });
  resumeMiningSession();
}
function startCooldownCountdown() {
    stopAllMiningSounds(); clearInterval(remainingTimeInterval);
    if(miningEffectContainer) miningEffectContainer.innerHTML = '';
    remainingTimeInterval = setInterval(() => {
        const remainingCooldown = (window.dailyMinedTimestamp + TWO_HOURS_MS) - Date.now();
        if (remainingCooldown <= 0) {
            clearInterval(remainingTimeInterval); remainingTimeInterval = null;
            if (window.dailyMinedTimestamp !== 0) {
                 window.updateDatabase({ dailyMinedTimestamp: 0, adsWatched: 0, adsWatchedTimestamp: 0 });
            }
            updateMiningButtonState(); return;
        }
        mineButton.disabled = true; mineButton.innerText = '‚è≥ Cooldown Active'; mineButton.style.background = '#808080';
        countdownDisplay.innerText = 'Next Mine in: ' + formatTime(remainingCooldown);
        updateAdStatus();
    }, 1000);
}
function updateMiningButtonState() {
    const miningStillActive = window.miningEndTime > Date.now();
    const isAdsComplete = window.adsWatched >= window.ADS_REQUIRED;
    updateAdStatus();
    if (miningStillActive) { updateCountdown(); }
    else if (!window.canMineAgain() && window.dailyMinedTimestamp !== 0) { stopAllMiningSounds(); startCooldownCountdown(); }
    else if (isAdsComplete) {
        if(miningEffectContainer) miningEffectContainer.innerHTML = '';
        mineCircle.classList.remove('mining-active-glow');
        mineButton.disabled = false; mineButton.innerText = 'ü™ô Start Mining'; mineButton.style.background = 'var(--primary-glow)';
        countdownDisplay.innerText = 'Click to start 1 hour session';
    } else {
        stopAllMiningSounds();
        if(miningEffectContainer) miningEffectContainer.innerHTML = '';
        mineCircle.classList.remove('mining-active-glow');
        mineButton.disabled = true; mineButton.innerText = `üîí Watch Ads to Unlock`; mineButton.style.background = '#808080';
        countdownDisplay.innerText = `Watch ${window.ADS_REQUIRED - window.adsWatched} more ads to start.`;
    }
    updateSoundState();
}

// ===================================================
// START: NEW DYNAMIC AD TASK SYSTEM
// ===================================================

function loadAdTasks() {
    const container = document.getElementById('ad-task-list');
    container.innerHTML = ''; 
    let activeTasksFound = false;

    for (const taskId in allAdTasks) {
        const task = allAdTasks[taskId];
        if (task && task.active) {
            activeTasksFound = true;
            
            // Current progress nikalo
            let progress = window.adTaskProgress[taskId] || { watchedCount: 0, timestamp: 0 };

            // === üî• AUTO REFRESH LOGIC ADDED HERE ===
            // Cooldown time milliseconds me convert karo (Default 24 hours agar set nahi hai)
            const cooldownHours = task.cooldownHours || 24;
            const cooldownMs = cooldownHours * 60 * 60 * 1000;
            
            // Check karo agar limit cross ho chuki thi
            if (progress.watchedCount >= task.limit) {
                const timeSinceLastComplete = Date.now() - progress.timestamp;
                
                // Agar abhi ka time > cooldown time hai, iska matlab time pura ho gaya
                if (timeSinceLastComplete > cooldownMs) {
                    // Progress Reset karo Local Variable me
                    progress = { watchedCount: 0, timestamp: 0 };
                    
                    // Database me bhi turant Reset karo taki user ko task khula mile
                    const updates = {};
                    updates[`adTaskProgress/${taskId}`] = progress;
                    update(window.dbRef, updates);
                    
                    // Global state update
                    window.adTaskProgress[taskId] = progress;
                    console.log(`Task ${task.title} reset successfully.`);
                }
            }
            // === üî• LOGIC END ===
            
            const taskElement = document.createElement('div');
            taskElement.className = 'ad-task-item';
            taskElement.style.backgroundColor = task.color || '#3B82F6';

            // Ab remaining time calculate karo (UI ke liye)
            const remainingCooldownMs = (progress.timestamp + cooldownMs) - Date.now();
            const onCooldown = progress.watchedCount >= task.limit && remainingCooldownMs > 0;
            
            taskElement.innerHTML = `
                <div class="ad-task-icon">
                    <img src="${task.iconUrl}" alt="icon">
                </div>
                <div class="ad-task-info">
                    <div class="title">${task.title} (+${task.reward})</div>
                    <div class="limit" id="limit-${taskId}">Limit: ${progress.watchedCount}/${task.limit}</div>
                </div>
                <div class="ad-task-button">
                    <button id="button-${taskId}" onclick="watchRewardAd('${taskId}')" ${onCooldown ? 'disabled' : ''}>
                        ${onCooldown ? '...' : 'Watch'}
                    </button>
                </div>
            `;
            container.appendChild(taskElement);
            
            // Agar abhi bhi cooldown bacha hai to timer chalao
            if (onCooldown) {
                startAdTaskCooldownTimer(taskId, remainingCooldownMs);
            }
        }
    }

    if (!activeTasksFound) {
        container.innerHTML = `<p style="text-align: center; color: #777;">No Ad Tasks available right now. Check back later!</p>`;
    }
}

function startAdTaskCooldownTimer(taskId, duration) {
    const button = document.getElementById(`button-${taskId}`);
    const limitText = document.getElementById(`limit-${taskId}`);
    if (!button || !limitText) return;

    let remaining = duration;
    
    const interval = setInterval(() => {
        remaining -= 1000;
        if (remaining <= 0) {
            clearInterval(interval);
            button.disabled = false;
            button.innerText = 'Watch';
            const progress = { watchedCount: 0, timestamp: 0 };
             window.adTaskProgress[taskId] = progress;
            limitText.innerText = `Limit: ${progress.watchedCount}/${allAdTasks[taskId].limit}`;
             // Reset progress in database
            update(ref(database, `${DB_NODE_PATH}/adTaskProgress/${taskId}`), progress);
        } else {
            button.innerText = formatTime(remaining);
            limitText.innerText = `Resets in...`;
        }
    }, 1000);
}

window.watchRewardAd = async (taskId) => {
    const task = allAdTasks[taskId];
    if (!task) {
        WebApp.showAlert("This task is no longer available.");
        return;
    }

    const progress = window.adTaskProgress[taskId] || { watchedCount: 0, timestamp: 0 };
    if (progress.watchedCount >= task.limit) {
        WebApp.showAlert("You have reached the limit for this task.");
        return;
    }

    const button = document.getElementById(`button-${taskId}`);
    button.disabled = true;
    button.innerText = '...';

    // === UPDATED LOGIC FOR GIGA PUB ===
    let showAdPromise;
    const providerName = (task.provider || "").toLowerCase().trim();

    if (providerName === 'adsgram') {
        showAdPromise = window.Adsgram.init({ blockId: task.blockId }).show();
    } 
    else if (providerName === 'gigapub') {
        // GIGA PUB LOGIC ADDED HERE
        if (typeof window.showGiga === 'function') {
             // Admin panel se jo "main" likha hoga, wo yahan aayega
             const placement = task.blockId || "main"; 
             showAdPromise = window.showGiga(placement);
        } else {
             console.error("Giga Pub SDK not loaded.");
             WebApp.showAlert("Giga Pub ads failed to load.");
             button.disabled = false;
             button.innerText = 'Watch';
             return;
        }
    }
    else if (providerName === 'adexora') {
        if (typeof window.showAdexora === 'function') {
             showAdPromise = window.showAdexora();
        } else {
             WebApp.showAlert("Adexora ads are not ready.");
             button.disabled = false;
             button.innerText = 'Watch';
             return;
        }
    } 
    else {
        // Default: Monetag
        showAdPromise = show_9969043();
    }

    try {
        await showAdPromise;
        
        // --- Success Logic ---
        const newCount = progress.watchedCount + 1;
        const currentCoins = parseFloat(window.coins) || 0;
        const reward = parseFloat(task.reward) || 0;

        const updates = {};
        updates.coins = currentCoins + reward;
        updates[`adTaskProgress/${taskId}/watchedCount`] = newCount;
        if (newCount >= task.limit) {
            updates[`adTaskProgress/${taskId}/timestamp`] = Date.now();
        }

        const historyRef = push(ref(database, `users/${TELEGRAM_USER_ID}/coin_history`));
        updates[`coin_history/${historyRef.key}`] = {
            reason: `${task.title} Ad Reward`,
            amount: reward,
            timestamp: Date.now()
        };

        await update(window.dbRef, updates);
        WebApp.showPopup({ message: `+${reward} Coins!` });
        playSuccessSound();
        loadUserData(); 
    } catch (error) {
        console.error("Ad error:", error);
        WebApp.showAlert("Ad was skipped or failed. No reward given.");
        loadUserData(); 
    }
};
// ===================================================
// END: NEW DYNAMIC AD TASK SYSTEM
// ===================================================

window.showWithdrawalModal = () => {
    if (withdrawalSettings.upi.locked) {
        WebApp.showPopup({ title: 'UPI Unavailable', message: withdrawalSettings.upi.message || 'UPI withdrawals are temporarily disabled.' });
        return;
    }
    withdrawalModal.style.display = "block";
    document.getElementById('upiAmount').value = '';
    document.getElementById('upiId').value = window.upiId;
    document.getElementById('inrValueText').innerText = '';
    submitWithdrawalBtn.disabled = true;
}
window.showPaypalModal = () => {
    if (withdrawalSettings.paypal.locked) {
        WebApp.showPopup({ title: 'PayPal Unavailable', message: withdrawalSettings.paypal.message || 'PayPal withdrawals are temporarily disabled.' });
        return;
    }
    paypalModal.style.display = "block";
    document.getElementById('paypalAmount').value = '';
    document.getElementById('paypalEmail').value = '';
    submitPaypalBtn.disabled = true;
}
window.showCryptoModal = () => {
    if (withdrawalSettings.crypto.locked) {
        WebApp.showPopup({ title: 'Crypto Unavailable', message: withdrawalSettings.crypto.message || 'Crypto withdrawals are temporarily disabled.' });
        return;
    }
    cryptoModal.style.display = "block";
    document.getElementById('cryptoAmount').value = '';
    document.getElementById('cryptoAddress').value = '';
    submitCryptoBtn.disabled = true;
}

window.closeWithdrawalModal = () => { withdrawalModal.style.display = "none"; }
window.closePaypalModal = () => { paypalModal.style.display = "none"; }
window.closeCryptoModal = () => { cryptoModal.style.display = "none"; }

window.checkWithdrawalEligibility = () => {
    const amountInput = document.getElementById('upiAmount');
    const amount = Number(amountInput.value);
    const inrValueText = document.getElementById('inrValueText');
    inrValueText.style.color = 'var(--primary-glow)';
    inrValueText.innerText = amount > 0 ? `Equivalent to ‚Çπ${(amount / 3000).toFixed(2)}` : '';
    if (amount >= MIN_WITHDRAWAL_COINS && amount <= (parseFloat(window.coins) || 0)) {
        submitWithdrawalBtn.disabled = false;
    } else {
        submitWithdrawalBtn.disabled = true;
        if (amount > 0 && amount < MIN_WITHDRAWAL_COINS) {
            inrValueText.innerText = `Error: Minimum is ${MIN_WITHDRAWAL_COINS} Coins.`;
            inrValueText.style.color = '#f44336';
        } else if (amount > (parseFloat(window.coins) || 0)) {
             inrValueText.innerText = `Error: Insufficient balance.`;
             inrValueText.style.color = '#f44336';
        }
    }
}

window.submitWithdrawal = async () => {
    const amount = Number(document.getElementById('upiAmount').value);
    const upiId = document.getElementById('upiId').value.trim();
    if (amount < MIN_WITHDRAWAL_COINS || amount > (parseFloat(window.coins) || 0)) { WebApp.showAlert(`Withdrawal failed: Amount must be valid.`); return; }
    if (upiId.length < 5 || !upiId.includes('@')) { WebApp.showAlert("Withdrawal failed: Please enter a valid UPI ID."); return; }

    if (userCountry === 'IN') {
        document.getElementById('withdrawalAdsModal').style.display = 'block';
        withdrawalAdsWatched = 0;
        document.getElementById('withdrawalAdStatus').innerText = `Ads Watched: ${withdrawalAdsWatched}/${WITHDRAWAL_ADS_REQUIRED}`;
    } else {
        await processWithdrawalRequest();
    }
};

async function processWithdrawalRequest() {
    try {
        const amount = Number(document.getElementById('upiAmount').value);
        const upiId = document.getElementById('upiId').value.trim();
        const userRef = ref(database, `users/${TELEGRAM_USER_ID}`);
        const snapshot = await get(userRef);
        const userData = snapshot.val();

        if (userCountry !== 'IN' && (!userData.completedTasks || Object.keys(userData.completedTasks).length === 0)) {
            WebApp.showAlert("You must complete at least one task before you can withdraw.");
            return;
        }

        // BUG FIX (Robust): Ensure coins is a number before subtracting
        const newCoinBalance = (parseFloat(window.coins) || 0) - amount;
        await update(window.dbRef, { coins: newCoinBalance, upiId: upiId });
        const withdrawalRequest = {
            userId: TELEGRAM_USER_ID, userName: USER_NAME, amount: amount, upiId: upiId,
            type: 'UPI', timestamp: Date.now(), status: 'Pending'
        };
        await push(WITHDRAWALS_REF, withdrawalRequest);
        playSuccessSound(); 
        closeWithdrawalModal();
        document.getElementById('withdrawalAdsModal').style.display = 'none';
        WebApp.showAlert(`Withdrawal of ${amount} Coins submitted successfully. Processing in 24 hours.`);

    } catch (error) {
        console.error("Withdrawal Error:", error);
        WebApp.showAlert("An error occurred during withdrawal. Please try again.");
    }
}

window.watchWithdrawalAd = () => {
    const watchBtn = document.getElementById('watchWithdrawalAdBtn');
    watchBtn.disabled = true; 
    watchBtn.innerText = 'üé• Loading Giga Ad...';

    // === GIGA PUB LOGIC (New) ===
    if (typeof window.showGiga === 'undefined') {
        WebApp.showAlert("Ad service failed to load. Please check your internet connection.");
        watchBtn.disabled = false; 
        watchBtn.innerText = 'üé¨ Watch Ad';
        return;
    }

    // Giga Pub Ad Show
    window.showGiga("main").then(() => {
        // --- Success ---
        withdrawalAdsWatched++;
        document.getElementById('withdrawalAdStatus').innerText = `Ads Watched: ${withdrawalAdsWatched}/${WITHDRAWAL_ADS_REQUIRED}`;
        
        if (withdrawalAdsWatched >= WITHDRAWAL_ADS_REQUIRED) {
            processWithdrawalRequest();
        }
    }).catch((e) => {
        // --- Error ---
        console.error("Giga Pub Error:", e);
        WebApp.showAlert("Ad was skipped. Please watch all ads to continue.");
    }).finally(() => {
        // Reset Button if needed
        if (withdrawalAdsWatched < WITHDRAWAL_ADS_REQUIRED) {
            watchBtn.disabled = false; 
            watchBtn.innerText = 'üé¨ Watch Ad';
        }
    });
}

window.checkPaypalEligibility = () => {
    const amount = Number(document.getElementById('paypalAmount').value);
    if (amount >= MIN_INTL_WITHDRAWAL_COINS && amount <= (parseFloat(window.coins) || 0)) { submitPaypalBtn.disabled = false; }
    else { submitPaypalBtn.disabled = true; }
}
window.checkCryptoEligibility = () => {
    const amount = Number(document.getElementById('cryptoAmount').value);
    if (amount >= MIN_INTL_WITHDRAWAL_COINS && amount <= (parseFloat(window.coins) || 0)) { submitCryptoBtn.disabled = false; }
    else { submitCryptoBtn.disabled = true; }
}
window.submitPaypalWithdrawal = async () => {
    const amount = Number(document.getElementById('paypalAmount').value);
    const paypalEmail = document.getElementById('paypalEmail').value.trim();
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (amount < MIN_INTL_WITHDRAWAL_COINS || amount > (parseFloat(window.coins) || 0)) { WebApp.showAlert(`Withdrawal failed: Amount must be valid.`); return; }
    if (!emailRegex.test(paypalEmail)) { WebApp.showAlert("Withdrawal failed: Please enter a valid PayPal email address."); return; }
    try {
        const userRef = ref(database, `users/${TELEGRAM_USER_ID}`);
        const snapshot = await get(userRef);
        const userData = snapshot.val();
        if (userData && userData.completedTasks && Object.keys(userData.completedTasks).length > 0) {
            const newCoinBalance = (parseFloat(window.coins) || 0) - amount;
            await update(window.dbRef, { coins: newCoinBalance });
            const withdrawalRequest = {
                userId: TELEGRAM_USER_ID, userName: USER_NAME, amount: amount, paypalEmail: paypalEmail,
                type: 'PayPal', timestamp: Date.now(), status: 'Pending'
            };
            await push(WITHDRAWALS_REF, withdrawalRequest);
            playSuccessSound(); closePaypalModal();
            WebApp.showAlert(`Withdrawal of ${amount} Coins to PayPal submitted successfully. Processing in 48 hours.`);
        } else {
            WebApp.showAlert("You must complete at least one task before you can withdraw.");
        }
    } catch (error) {
        console.error("PayPal Withdrawal Error:", error);
        WebApp.showAlert("An error occurred during withdrawal. Please try again.");
    }
};
window.submitCryptoWithdrawal = async () => {
    const amount = Number(document.getElementById('cryptoAmount').value);
    const cryptoAddress = document.getElementById('cryptoAddress').value.trim();
    if (amount < MIN_INTL_WITHDRAWAL_COINS || amount > (parseFloat(window.coins) || 0)) { WebApp.showAlert(`Withdrawal failed: Amount must be valid.`); return; }
    if (cryptoAddress.length < 26) { WebApp.showAlert("Withdrawal failed: Please enter a valid USDT (TRC20) wallet address."); return; }
    try {
        const userRef = ref(database, `users/${TELEGRAM_USER_ID}`);
        const snapshot = await get(userRef);
        const userData = snapshot.val();
        if (userData && userData.completedTasks && Object.keys(userData.completedTasks).length > 0) {
            const newCoinBalance = (parseFloat(window.coins) || 0) - amount;
            await update(window.dbRef, { coins: newCoinBalance });
            const withdrawalRequest = {
                userId: TELEGRAM_USER_ID, userName: USER_NAME, amount: amount, cryptoAddress: cryptoAddress,
                network: 'USDT_TRC20', type: 'Crypto', timestamp: Date.now(), status: 'Pending'
            };
            await push(WITHDRAWALS_REF, withdrawalRequest);
            playSuccessSound(); closeCryptoModal();
            WebApp.showAlert(`Withdrawal of ${amount} Coins to Crypto Wallet submitted successfully. Processing in 48 hours.`);
        } else {
            WebApp.showAlert("You must complete at least one task before you can withdraw.");
        }
    } catch (error) {
        console.error("Crypto Withdrawal Error:", error);
        WebApp.showAlert("An error occurred during withdrawal. Please try again.");
    }
};
window.onclick = function(event) {
    if (event.target == withdrawalModal) { window.closeWithdrawalModal(); }
    if (event.target == taskDetailModal) { closeTaskModal(); }
    if (event.target == paypalModal) { window.closePaypalModal(); }
    if (event.target == cryptoModal) { window.closeCryptoModal(); }
}

document.addEventListener('DOMContentLoaded', () => {
    loadWithdrawalLockSettings();
    loadAdminSettings();
    loadUserData();
    loadLiveTasks();
    loadWithdrawalHistory();
    listenForNotifications();
    listenForAdminPopups();
    document.body.addEventListener('click', primeAudio, { once: true });
    document.body.addEventListener('click', (event) => {
        if (event.target.matches('button, .nav-btn, .msg-icon, .profile, .task-item, .close-btn, .task-nav-btn')) {
            playClickSound();
        }
    });
    document.addEventListener('visibilitychange', () => {
        if (!document.hidden) { 
            const awaitingPopup = sessionStorage.getItem('awaitingVerificationPopup');
            if (awaitingPopup) {
                WebApp.showPopup({
                    title: 'Task in Progress',
                    message: 'Welcome back! Please wait about a minute for the "Verify Task" button to become active, then click it to get your reward.'
                });
                sessionStorage.removeItem('awaitingVerificationPopup');
            }
            loadLiveTasks();
        }
    });
    document.getElementById('customerCareLink').addEventListener('click', function(event) {
        event.preventDefault();
        const userIdToCopy = TELEGRAM_USER_ID;
        navigator.clipboard.writeText(userIdToCopy).then(() => {
            WebApp.showAlert('Your User ID has been copied to the clipboard! You will now be redirected to support.');
            WebApp.openTelegramLink('https://t.me/MiningFatherhelp');
        }).catch(err => {
            console.error('Failed to copy User ID: ', err);
            WebApp.showAlert('Could not copy your User ID automatically. Please copy it manually.');
            WebApp.openTelegramLink('https://t.me/MiningFatherhelp');
        });
    });
});

window.showSection = (sectionId, button) => {
  document.querySelectorAll('.section').forEach(s => s.style.display = 'none');
  
  const mainElement = document.querySelector('main');
  mainElement.style.display = 'flex';
  document.getElementById(sectionId).style.display = 'block';

  document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
  button.classList.add('active');
  updateSoundState();
}

window.showTaskCategory = (category, button) => {
    document.getElementById('daily-tasks').style.display = 'none';
    document.getElementById('premium-tasks').style.display = 'none';
    document.getElementById(`${category}-tasks`).style.display = 'block';
    document.querySelectorAll('.task-nav-btn').forEach(btn => btn.classList.remove('active'));
    button.classList.add('active');
}

window.showProfile = () => { WebApp.showAlert(`User Profile:\nName: ${USER_NAME}\nID: ${TELEGRAM_USER_ID}`); }
window.showMsg = () => { WebApp.showPopup({message: 'Welcome to CoinMine!'}); }
</script>
</body>
</html>
